import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import plotly.graph_objects as go
from scipy.optimize import minimize

# Configuration de la page
st.set_page_config(page_title="Portfolio Manager SBF 120", layout="wide")

st.title("üìä Analyse de Portefeuille Efficient & ESG")
st.markdown("""
*Projet Acad√©mique : Gestion de Portefeuille sur le SBF 120 (2015-2025)*
""")

# 1. CHARGEMENT DES DONN√âES ESG (√Ä personnaliser avec tes titres)
@st.cache_data
def load_esg_data():
    # Exemple de base de donn√©es ESG
    data = {
        'Ticker': ['OR.PA', 'MC.PA', 'AIR.PA', 'RMS.PA', 'TTE.PA', 'SAN.PA', 'KER.PA', 'BNP.PA', 'AI.PA', 'EL.PA'],
        'ESG_Score': [82, 75, 70, 85, 60, 78, 80, 72, 88, 77]
    }
    return pd.DataFrame(data)

esg_df = load_esg_data()
tickers = esg_df['Ticker'].tolist()

# 2. R√âCUP√âRATION DES DONN√âES FINANCI√àRES (yfinance)
@st.cache_data
def get_stock_data(tickers):
    data = yf.download(tickers, start="2015-01-01", end="2025-12-31", interval="1mo")['Adj Close']
    return data

df_prices = get_stock_data(tickers)
returns = df_prices.pct_change().dropna()

# --- CALCULS FINANCIERS ---
mean_returns = returns.mean()
cov_matrix = returns.cov()

def portfolio_performance(weights, mean_returns, cov_matrix):
    port_return = np.sum(mean_returns * weights) * 12
    port_std = np.sqrt(np.dot(weights.T, np.dot(cov_matrix * 12, weights)))
    return port_return, port_std

# Optimisation pour la Fronti√®re Efficiente
def minimize_volatility(weights):
    return portfolio_performance(weights, mean_returns, cov_matrix)[1]

# 3. INTERFACE STREAMLIT - SIDEBAR
st.sidebar.header("Configuration du Portefeuille")
selected_assets = st.sidebar.multiselect("S√©lectionnez vos 10 titres", tickers, default=tickers)

# Calcul des poids (Equipond√©r√© par d√©faut pour l'exemple)
if len(selected_assets) > 0:
    weights = np.array([1/len(selected_assets)] * len(selected_assets))
    
    # Calcul score ESG Portefeuille
    relevant_esg = esg_df[esg_df['Ticker'].isin(selected_assets)]
    portfolio_esg = np.sum(relevant_esg['ESG_Score'].values * weights)

    # --- AFFICHAGE DES M√âTRIQUES CL√âS ---
    col1, col2, col3 = st.columns(3)
    p_ret, p_vol = portfolio_performance(weights, mean_returns[selected_assets], cov_matrix.loc[selected_assets, selected_assets])
    
    col1.metric("Rendement Annuel (Esp√©r√©)", f"{p_ret:.2%}")
    col2.metric("Volatilit√© Annuelle", f"{p_vol:.2%}")
    col3.metric("Score ESG Moyen", f"{portfolio_esg:.1f}/100")

    # --- VISUALISATION : FRONTI√àRE EFFICIENTE ---
    st.subheader("Fronti√®re des Possibilit√©s & Fronti√®re Efficiente")
    
        
    num_portfolios = 2000
    results = np.zeros((3, num_portfolios))
    for i in range(num_portfolios):
        w = np.random.random(len(selected_assets))
        w /= np.sum(w)
        r, v = portfolio_performance(w, mean_returns[selected_assets], cov_matrix.loc[selected_assets, selected_assets])
        results[0,i] = v
        results[1,i] = r
        results[2,i] = r / v # Sharpe Ratio simple

    fig = go.Figure()
    # Nuage de points (Possibilit√©s)
    fig.add_trace(go.Scatter(x=results[0,:], y=results[1,:], mode='markers', 
                             marker=dict(color=results[2,:], colorscale='Viridis', showscale=True),
                             name="Portefeuilles Al√©atoires"))
    
    # Ton Portefeuille
    fig.add_trace(go.Scatter(x=[p_vol], y=[p_ret], marker=dict(color='red', size=15, symbol='star'),
                             name="Votre Portefeuille"))

    fig.update_layout(xaxis_title="Volatilit√© (Risque)", yaxis_title="Rendement Esp√©r√©")
    st.plotly_chart(fig, use_container_width=True)

    # --- ARGUMENTAIRE ---
    st.subheader("Pourquoi acheter ce portefeuille ?")
    col_a, col_b = st.columns(2)
    with col_a:
        st.write("**Arguments Financiers :**")
        st.write("- Diversification sectorielle au sein du SBF 120.")
        st.write(f"- Ratio de Sharpe estim√© attractif.")
    with col_b:
        st.write("**Arguments Extra-financiers (ESG) :**")
        st.write(f"- Score ESG de {portfolio_esg:.1f} sup√©rieur √† la moyenne du march√©.")
        st.write("- S√©lection de leaders en transition √©nerg√©tique.")

else:
    st.error("Veuillez s√©lectionner au moins un titre.")
